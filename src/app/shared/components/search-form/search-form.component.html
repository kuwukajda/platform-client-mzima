<form
  novalidate
  [formGroup]="form"
  class="search-form"
  (submit)="applyFilters()"
  [ngClass]="{ 'search-form--filters-open': isFiltersVisible }"
>
  <mat-form-field appearance="outline" class="search-form__control">
    <mat-icon matPrefix svgIcon="search"></mat-icon>
    <input
      matInput
      [(ngModel)]="searchQuery"
      (ngModelChange)="searchPosts()"
      class="search-form__form-control"
      [ngModelOptions]="{ standalone: true }"
      [placeholder]="'global_filter.search' | translate"
    />
    <button
      matSuffix
      type="button"
      mat-icon-button
      *ngIf="searchQuery?.length"
      (click)="clearPostsResults()"
    >
      <mat-icon svgIcon="close"></mat-icon>
    </button>
  </mat-form-field>
  <button
    type="button"
    mat-raised-button
    (click)="toggleFilters(!isFiltersVisible)"
    class="search-form__filters"
  >
    <mat-icon class="search-form__filters__icon" svgIcon="filters"></mat-icon>
    {{ 'app.filters' | translate }}
  </button>

  <div class="search-form__main-filters">
    <span class="search-form__main-filters__total" *ngIf="total !== undefined">
      {{ 'post.search_results' | translate }} {{ total }}
    </span>

    <div class="collection-info" *ngIf="collectionInfo">
      <span class="collection-info__title">
        Collection
        {{ collectionInfo.name }}
        <button
          mat-button
          type="button"
          color="primary"
          (click)="clearCollection()"
          class="filter-group__head__button"
        >
          {{ 'nav.clear' | translate }}
        </button>
      </span>

      <div class="collection-info__description" *ngIf="collectionInfo.description?.length">
        {{ collectionInfo.description }}
      </div>
    </div>

    <div class="filter-group" *ngIf="surveyList?.length">
      <div class="filter-group__head">
        <label class="filter-group__title" for="surveys">{{ 'app.surveys' | translate }}</label>
        <button
          mat-button
          type="button"
          color="primary"
          (click)="clearFilter('form')"
          class="filter-group__head__button"
        >
          {{ 'nav.clear' | translate }}
        </button>
      </div>
      <mat-selection-list name="surveys" class="selection-list" formControlName="form">
        <mat-list-option
          color="primary"
          [value]="survey.id"
          checkboxPosition="before"
          class="selection-list__option"
          *ngFor="let survey of surveyList"
          [ngStyle]="{ '--color': survey.color }"
        >
          <span class="selection-list__option__border"></span>
          {{ survey.name }}
          <span class="selection-list__option__total">{{ survey.total || 0 }}</span>
        </mat-list-option>
      </mat-selection-list>

      <div class="filter-group__info">
        <span *ngIf="notShownPostsCount <= 0">{{ 'global_filter.unmapped_none' | translate }}</span>
        <span *ngIf="notShownPostsCount === 1">{{
          'global_filter.unmapped_start_one' | translate
        }}</span>
        <span *ngIf="notShownPostsCount >= 2">{{
          'global_filter.unmapped_start_many' | translate
        }}</span>
        <a [routerLink]="['feed']" *ngIf="notShownPostsCount >= 1">
          {{ notShownPostsCount }} post{{ notShownPostsCount >= 2 ? 's' : '' }}
        </a>
        <span *ngIf="notShownPostsCount >= 1">{{ 'global_filter.unmapped_end' | translate }}</span>
      </div>
    </div>

    <div class="filter-group" *ngIf="sources?.length && showSources">
      <div class="filter-group__head">
        <label class="filter-group__title" for="source">
          {{ 'global_filter.source' | translate }}
        </label>
        <button
          mat-button
          type="button"
          color="primary"
          (click)="clearFilter('source')"
          class="filter-group__head__button"
        >
          {{ 'nav.clear' | translate }}
        </button>
      </div>
      <mat-selection-list name="source" class="selection-list" formControlName="source">
        <ng-container *ngFor="let source of sources">
          <mat-list-option
            color="primary"
            [value]="source.value"
            *ngIf="source.total > 0"
            checkboxPosition="before"
            class="selection-list__option"
          >
            {{ source.name }}
            <span class="selection-list__option__total">{{ source.total }}</span>
          </mat-list-option>
        </ng-container>
      </mat-selection-list>
    </div>
  </div>

  <div
    class="search-form__filters-panel"
    [ngClass]="{ 'search-form__filters-panel--open': isFiltersVisible }"
  >
    <app-filter-control
      title="{{ 'global_filter.saved_filters' | translate }}"
      [type]="filterType.Select"
      [options]="savedsearches"
      [canEdit]="isLoggedIn"
      (editOption)="saveSearch($event)"
      [(ngModel)]="activeSavedSearchValue"
      [ngModelOptions]="{ standalone: true }"
      (filterChange)="applySavedFilter($event)"
      class="search-form__filters-panel__item"
      [badge]="activeSavedSearchValue ? 1 : null"
    >
      <button
        postfix
        mat-button
        color="primary"
        (click)="saveSearch()"
        class="save-filter-button small"
      >
        <mat-icon svgIcon="plus" class="save-filter-button__icon"></mat-icon>
        {{ 'global_filter.save_new_filter' | translate }}
      </button>
    </app-filter-control>

    <app-filter-control
      [options]="statuses"
      formControlName="status"
      [fields]="['value', 'name']"
      [type]="filterType.Multiselect"
      class="search-form__filters-panel__item"
      [title]="'global_filter.status' | translate"
      [badge]="form.controls['status'].value?.length || null"
    >
    </app-filter-control>

    <app-filter-control
      formControlName="tags"
      [options]="categoriesData"
      [type]="filterType.Multilevelselect"
      [title]="'app.categories' | translate"
      class="search-form__filters-panel__item"
      [badge]="form.controls['tags'].value?.length || null"
    >
    </app-filter-control>

    <app-filter-control
      formControlName="date"
      [type]="filterType.Daterange"
      class="search-form__filters-panel__item"
      [title]="'global_filter.date_range' | translate"
      [badge]="
        form.controls['date'].value?.start?.length || form.controls['date'].value?.start?.length
          ? 1
          : null
      "
    >
    </app-filter-control>

    <app-filter-control
      [type]="filterType.Location"
      formControlName="center_point"
      class="search-form__filters-panel__item"
      [title]="'global_filter.location' | translate"
      [badge]="form.controls['center_point'].value?.length ? 1 : null"
    >
    </app-filter-control>

    <div class="search-form__filters-panel__item search-form__filters-panel__item--controls">
      <button
        color="dark"
        type="button"
        mat-stroked-button
        [disabled]="form.disabled"
        class="search-form__button"
        (click)="resetSavedFilter()"
      >
        {{ 'global_filter.clear_all_filters' | translate }}
      </button>
    </div>
  </div>
</form>
